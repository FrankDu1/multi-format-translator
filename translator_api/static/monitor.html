<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»è¯‘æœåŠ¡ç›‘æ§ä»ªè¡¨ç›˜</title>
    <!-- ç§»é™¤ Chart.js è„šæœ¬ -->
    <script>
        window.ENV_CONFIG = {
            API_BASE_URL: (() => {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:29003/api';
                } else {
                    return 'https://offerupup.cn/translator-api/api';
                }
            })(),
            
            APP_ENV: window.location.hostname === 'localhost' ? 'development' : 'production',
            VERSION: '3.0.0',
            APP_NAME: 'Image Translator',
            
            getApiUrl() {
                return this.API_BASE_URL;
            },
            
            getEnv() {
                return this.APP_ENV;
            },
            
            getVersion() {
                return this.VERSION;
            }
        };
        
        console.log('âœ… ENV_CONFIG å·²å®šä¹‰:', window.ENV_CONFIG.API_BASE_URL);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #718096;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: #1a202c;
        }

        .stat-card .change {
            font-size: 14px;
            margin-top: 8px;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .change.positive {
            background: #c6f6d5;
            color: #22543d;
        }

        .change.negative {
            background: #fed7d7;
            color: #742a2a;
        }

        .chart-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* ç§»é™¤ height å’Œ flex-direction */
        }

        .chart-card h2 {
            font-size: 18px;
            color: #1a202c;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* æ·»åŠ ç®€å•çš„æ–‡æœ¬æ˜¾ç¤ºæ ·å¼ */
        .chart-data {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chart-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .chart-item:last-child {
            border-bottom: none;
        }

        .period-tabs {
            display: flex;
            gap: 8px;
        }

        .period-tab {
            padding: 6px 12px;
            border: none;
            background: #e2e8f0;
            color: #4a5568;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .period-tab.active {
            background: #667eea;
            color: white;
        }

        .table-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            font-size: 18px;
            color: #1a202c;
        }

        .filters {
            display: flex;
            gap: 12px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #2d3748;
        }

        tr:hover {
            background: #f7fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-failed {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-error {
            background: #feebc8;
            color: #7c2d12;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .type-image {
            background: #bee3f8;
            color: #2c5282;
        }

        .type-pdf {
            background: #fbd38d;
            color: #7c2d12;
        }

        .type-ppt {
            background: #d6bcfa;
            color: #44337a;
        }

        .type-text {
            background: #c6f6d5;
            color: #22543d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .system-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .service-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .service-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-online {
            background: #48bb78;
        }

        .status-offline {
            background: #f56565;
        }

        @media (max-width: 768px) {
            .chart-section {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
            }
            
            .chart-card {
                height: 350px; /* ğŸ”¥ ç§»åŠ¨ç«¯ç¨å¾®å°ä¸€ç‚¹ */
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state img {
            width: 120px;
            opacity: 0.5;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>
                <span>ğŸš€</span>
                ç¿»è¯‘æœåŠ¡ç›‘æ§ä»ªè¡¨ç›˜
            </h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
                <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
            </div>
        </div>

        <!-- å®æ—¶ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>ğŸ“Š æ€»è¯·æ±‚æ•°</h3>
                <div class="value" id="totalRequests">-</div>
            </div>
            <div class="stat-card">
                <h3>âœ… æˆåŠŸç‡</h3>
                <div class="value" id="successRate">-</div>
            </div>
            <div class="stat-card">
                <h3>â±ï¸ å¹³å‡è€—æ—¶</h3>
                <div class="value" id="avgTime">-</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ‘¥ æ´»è·ƒç”¨æˆ·</h3>
                <div class="value" id="uniqueIps">-</div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="system-status" id="systemStatus"></div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="chart-section">
            <div class="chart-card">
                <h2>
                    ğŸ“ˆ è¯·æ±‚è¶‹åŠ¿
                    <div class="period-tabs">
                        <button class="period-tab active" onclick="changePeriod('today')">ä»Šæ—¥</button>
                        <button class="period-tab" onclick="changePeriod('7days')">7å¤©</button>
                        <button class="period-tab" onclick="changePeriod('30days')">30å¤©</button>
                    </div>
                </h2>
                <div id="trendData" class="chart-data">
                    <!-- æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div class="chart-card">
                <h2>ğŸ¯ ç¿»è¯‘ç±»å‹åˆ†å¸ƒ</h2>
                <div id="typeData" class="chart-data">
                    <!-- æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- è¯·æ±‚è®°å½•è¡¨æ ¼ -->
        <div class="table-section">
            <div class="table-header">
                <h2>ğŸ“‹ æœ€è¿‘è¯·æ±‚è®°å½•</h2>
                <div class="filters">
                    <select class="filter-select" id="typeFilter" onchange="filterRequests()">
                        <option value="">æ‰€æœ‰ç±»å‹</option>
                        <option value="image">å›¾ç‰‡</option>
                        <option value="pdf">PDF</option>
                        <option value="ppt">PPT</option>
                        <option value="text">æ–‡æœ¬</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="filterRequests()">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="success">æˆåŠŸ</option>
                        <option value="failed">å¤±è´¥</option>
                        <option value="error">é”™è¯¯</option>
                    </select>
                </div>
            </div>
            <div id="requestsTable"></div>
        </div>

        <!-- é”™è¯¯æ—¥å¿— -->
        <div class="table-section">
            <div class="table-header">
                <h2>ğŸ› é”™è¯¯æ—¥å¿—</h2>
            </div>
            <div id="errorLogs"></div>
        </div>
    </div>

    <script>
        let currentPeriod = 'today';
        let trendChart = null;
        let typeChart = null;
        let allStats = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(loadData, 30000);
        });

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                const statsResponse = await fetch(`${window.ENV_CONFIG.getApiUrl()}/monitor/stats?period=${currentPeriod}`);
                const stats = await statsResponse.json();
                allStats = stats;

                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                updateStatsCards(stats);

                // æ›´æ–°å›¾è¡¨
                updateCharts(stats);

                // åŠ è½½ä»Šæ—¥è¯·æ±‚è®°å½•
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const requestsResponse = await fetch(`${window.ENV_CONFIG.getApiUrl()}/monitor/requests?date=${today}&limit=50`);
                const requests = await requestsResponse.json();
                updateRequestsTable(requests.records);

                // æ›´æ–°é”™è¯¯æ—¥å¿—
                updateErrorLogs(stats.error_logs);

                // åŠ è½½ç³»ç»ŸçŠ¶æ€
                const systemResponse = await fetch(`${window.ENV_CONFIG.getApiUrl()}/monitor/system`);
                const system = await systemResponse.json();
                updateSystemStatus(system);

            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStatsCards(stats) {
            document.getElementById('totalRequests').textContent = stats.total_requests.toLocaleString();
            document.getElementById('successRate').textContent = stats.success_rate + '%';
            document.getElementById('avgTime').textContent = stats.avg_processing_time + 's';
            document.getElementById('uniqueIps').textContent = stats.unique_ips;
        }

        // æ›´æ–°å›¾è¡¨ï¼ˆæ”¹ä¸ºæ–‡æœ¬æ˜¾ç¤ºï¼‰
        function updateCharts(stats) {
            // è¶‹åŠ¿æ•°æ®
            const trendContainer = document.getElementById('trendData');
            let trendHtml = '';
            stats.daily_stats.forEach(day => {
                trendHtml += `
                    <div class="chart-item">
                        <span>${day.date}</span>
                        <span>æ€»: ${day.total} | æˆåŠŸ: ${day.success} | å¤±è´¥: ${day.failed}</span>
                    </div>
                `;
            });
            trendContainer.innerHTML = trendHtml;

            // ç±»å‹åˆ†å¸ƒ
            const typeContainer = document.getElementById('typeData');
            let typeHtml = '';
            Object.entries(stats.type_distribution).forEach(([type, count]) => {
                typeHtml += `
                    <div class="chart-item">
                        <span>${type.toUpperCase()}</span>
                        <span>${count}</span>
                    </div>
                `;
            });
            typeContainer.innerHTML = typeHtml;
        }

        // æ›´æ–°è¯·æ±‚è¡¨æ ¼
        function updateRequestsTable(records) {
            const container = document.getElementById('requestsTable');
            
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="empty-state">ğŸ“­ æš‚æ— æ•°æ®</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>IPåœ°å€</th>
                            <th>ç±»å‹</th>
                            <th>çŠ¶æ€</th>
                            <th>æ–‡ä»¶å</th>
                            <th>è€—æ—¶</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            records.forEach(record => {
                const time = new Date(record.timestamp).toLocaleTimeString('zh-CN');
                const statusClass = record.status === 'success' ? 'status-success' : 
                                  record.status === 'failed' ? 'status-failed' : 'status-error';
                const typeClass = `type-${record.translation_type}`;
                
                html += `
                    <tr>
                        <td>${time}</td>
                        <td>${record.client_ip}</td>
                        <td><span class="type-badge ${typeClass}">${record.translation_type.toUpperCase()}</span></td>
                        <td><span class="status-badge ${statusClass}">${record.status}</span></td>
                        <td>${record.file_name || '-'}</td>
                        <td>${record.processing_time_seconds}s</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // æ›´æ–°é”™è¯¯æ—¥å¿—
        function updateErrorLogs(errors) {
            const container = document.getElementById('errorLogs');
            
            if (!errors || errors.length === 0) {
                container.innerHTML = '<div class="empty-state">âœ… æš‚æ— é”™è¯¯</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>IPåœ°å€</th>
                            <th>ç±»å‹</th>
                            <th>é”™è¯¯ä¿¡æ¯</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            errors.forEach(error => {
                const time = new Date(error.timestamp).toLocaleString('zh-CN');
                
                html += `
                    <tr>
                        <td>${time}</td>
                        <td>${error.client_ip}</td>
                        <td><span class="type-badge type-${error.translation_type}">${error.translation_type.toUpperCase()}</span></td>
                        <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${error.error_message}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(system) {
            const container = document.getElementById('systemStatus');
            
            html = `
                <div class="service-card">
                    <h3>ğŸ’» CPU ä½¿ç”¨ç‡</h3>
                    <div class="value" style="font-size: 24px;">${system.cpu_percent}%</div>
                </div>
                <div class="service-card">
                    <h3>ğŸ§  å†…å­˜ä½¿ç”¨</h3>
                    <div class="value" style="font-size: 24px;">${system.memory_percent}%</div>
                    <small>${system.memory_used_gb}GB / ${system.memory_total_gb}GB</small>
                </div>
                <div class="service-card">
                    <h3>ğŸ“ ä¸Šä¼ æ–‡ä»¶</h3>
                    <div class="value" style="font-size: 24px;">${system.upload_folder.files_count}</div>
                    <small>${system.upload_folder.used_gb}GB / ${system.upload_folder.total_gb}GB</small>
                </div>
                <div class="service-card">
                    <h3>ğŸ“¦ å½’æ¡£æ–‡ä»¶</h3>
                    <div class="value" style="font-size: 24px;">${system.archive_folder.files_count}</div>
                    <small>${system.archive_folder.total_size_gb}GB</small>
                </div>
                <div class="service-card">
                    <h3>ğŸ” OCR æœåŠ¡</h3>
                    <div class="service-status">
                        <span class="status-dot ${system.services.ocr ? 'status-online' : 'status-offline'}"></span>
                        <span>${system.services.ocr ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span>
                    </div>
                </div>
                <div class="service-card">
                    <h3>ğŸ¨ Inpaint æœåŠ¡</h3>
                    <div class="service-status">
                        <span class="status-dot ${system.services.inpaint ? 'status-online' : 'status-offline'}"></span>
                        <span>${system.services.inpaint !== null ? (system.services.inpaint ? 'åœ¨çº¿' : 'ç¦»çº¿') : 'æœªå¯ç”¨'}</span>
                    </div>
                </div>
                <div class="service-card">
                    <h3>â±ï¸ è¿è¡Œæ—¶é—´</h3>
                    <div class="value" style="font-size: 20px;">${system.uptime}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // åˆ‡æ¢æ—¶é—´å‘¨æœŸ
        function changePeriod(period) {
            currentPeriod = period;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.period-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadData();
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadData();
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (!allStats) return;
            
            const dataStr = JSON.stringify(allStats, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `monitor_data_${new Date().toISOString()}.json`;
            link.click();
        }

        // ç­›é€‰è¯·æ±‚
        async function filterRequests() {
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            let url = `${window.ENV_CONFIG.getApiUrl()}/monitor/requests?date=${today}&limit=50`;
            
            if (typeFilter) url += `&type=${typeFilter}`;
            if (statusFilter) url += `&status=${statusFilter}`;
            
            const response = await fetch(url);
            const requests = await response.json();
            updateRequestsTable(requests.records);
        }
    </script>
</body>
</html>