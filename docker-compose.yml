version: '3.8'

services:
  # OCR服务
  ocr:
    build:
      context: ./ocr
      dockerfile: Dockerfile
    container_name: translator-ocr
    ports:
      - "${OCR_PORT:-8899}:8899"
    environment:
      - PYTHONIOENCODING=utf-8
      - OCR_HOST=0.0.0.0
      - OCR_PORT=8899
      - ALLOWED_ORIGINS=*
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - translator-network

  # Inpaint服务
  inpaint:
    build:
      context: ./inpaint
      dockerfile: Dockerfile
    container_name: translator-inpaint
    ports:
      - "${INPAINT_PORT:-8900}:8900"
    environment:
      - PYTHONIOENCODING=utf-8
      - INPAINT_HOST=0.0.0.0
      - INPAINT_PORT=8900
      - ALLOWED_ORIGINS=*
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - translator-network

  # API服务
  api:
    build:
      context: ./translator_api
      dockerfile: Dockerfile
    container_name: translator-api
    ports:
      - "${API_PORT:-5002}:5002"
    environment:
      - PYTHONIOENCODING=utf-8
      - API_HOST=0.0.0.0
      - API_PORT=5002
      - OCR_SERVICE_URL=http://ocr:8899/ocr
      - INPAINT_SERVICE_URL=http://inpaint:8900/inpaint
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5001}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://localhost:11434}
      - MONITOR_USERNAME=${MONITOR_USERNAME:-admin}
      - MONITOR_PASSWORD_HASH=${MONITOR_PASSWORD_HASH}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-16777216}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PRODUCTION_DOMAIN=${PRODUCTION_DOMAIN}
      - USE_CLOUD_TRANSLATE=${USE_CLOUD_TRANSLATE:-true}
      - ALI_ACCESS_KEY_ID=${ALI_ACCESS_KEY_ID}
      - ALI_ACCESS_KEY_SECRET=${ALI_ACCESS_KEY_SECRET}
      - QWEN_API_KEY=${QWEN_API_KEY}
    volumes:
      - ./translator_api/uploads:/app/uploads
      - ./translator_api/archives:/app/archives
      - ./logs:/app/logs
    depends_on:
      - ocr
      - inpaint
    restart: unless-stopped
    networks:
      - translator-network

  # 前端服务
  frontend:
    build:
      context: ./translator_frontend
      dockerfile: Dockerfile
    container_name: translator-frontend
    ports:
      - "${FRONTEND_PORT:-5001}:80"
    environment:
      # 移除 API_BASE_URL 环境变量，让前端 JS 自动根据域名计算
      - APP_ENV=production
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - translator-network

networks:
  translator-network:
    driver: bridge

volumes:
  logs:
  uploads:
  archives:
